#!/bin/bash
set -e

# Configuration
LOKI_URL="{{ loki_url }}"
HOST_IP="{{ host_ip }}"
RESOURCE_NAME="{{ resource_name }}"
PROMTAIL_CONFIG_DIR="/etc/promtail"
PROMTAIL_POSITIONS_DIR="/var/lib/promtail"
PROMTAIL_CONFIG_FILE="$PROMTAIL_CONFIG_DIR/config.yaml"

# Check for Docker
if ! command -v docker &> /dev/null; then
    echo "Error: Docker is not installed. Please install Docker first."
    exit 1
fi

echo "Docker is installed."

# Create Promtail directories
if [ ! -d "$PROMTAIL_CONFIG_DIR" ]; then
    echo "Creating directory $PROMTAIL_CONFIG_DIR"
    mkdir -p "$PROMTAIL_CONFIG_DIR"
fi

if [ ! -d "$PROMTAIL_POSITIONS_DIR" ]; then
    echo "Creating directory $PROMTAIL_POSITIONS_DIR"
    mkdir -p "$PROMTAIL_POSITIONS_DIR"
fi

# Generate Promtail configuration
echo "Generating Promtail configuration at $PROMTAIL_CONFIG_FILE"
cat <<EOF > "$PROMTAIL_CONFIG_FILE"
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: $PROMTAIL_POSITIONS_DIR/positions.yaml

clients:
  - url: $LOKI_URL/loki/api/v1/push

scrape_configs:
- job_name: system
  static_configs:
  - targets:
      - localhost
    labels:
      job: varlogs
      host: $RESOURCE_NAME
      ip: $HOST_IP
      __path__: /var/log/*.log
EOF

# Stop and remove existing Promtail container if running
if docker ps -a --format '{{.Names}}' | grep -q "^promtail$"; then
    echo "Stopping and removing existing promtail container..."
    docker stop promtail || true
    docker rm promtail || true
fi

# Run Promtail container
echo "Starting Promtail container..."
docker run -d \
  --name promtail \
  --restart always \
  -v $PROMTAIL_CONFIG_DIR:/etc/promtail \
  -v $PROMTAIL_POSITIONS_DIR:$PROMTAIL_POSITIONS_DIR \
  -v /var/log:/var/log \
  grafana/promtail:latest \
  -config.file=/etc/promtail/config.yaml

echo "Promtail deployed successfully."
