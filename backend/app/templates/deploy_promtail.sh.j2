#!/bin/bash
set -e

# Configuration
LOKI_URL="{{ loki_url }}"
HOST_IP="{{ host_ip }}"
RESOURCE_NAME="{{ resource_name }}"
PROMTAIL_CONFIG_DIR="/etc/promtail"
PROMTAIL_POSITIONS_DIR="/var/lib/promtail"
PROMTAIL_CONFIG_FILE="$PROMTAIL_CONFIG_DIR/config.yaml"

# Determine sudo usage
SUDO=""
if [ "$(id -u)" != "0" ]; then
    if command -v sudo &> /dev/null; then
        SUDO="sudo"
    else
        echo "Error: This script must be run as root or with sudo."
        exit 1
    fi
fi

# Check for Docker
if ! command -v docker &> /dev/null; then
    echo "Error: Docker is not installed. Please install Docker first."
    exit 1
fi

echo "Docker is installed."

# Create Promtail directories
if [ ! -d "$PROMTAIL_CONFIG_DIR" ]; then
    echo "Creating directory $PROMTAIL_CONFIG_DIR"
    $SUDO mkdir -p "$PROMTAIL_CONFIG_DIR"
fi

if [ ! -d "$PROMTAIL_POSITIONS_DIR" ]; then
    echo "Creating directory $PROMTAIL_POSITIONS_DIR"
    $SUDO mkdir -p "$PROMTAIL_POSITIONS_DIR"
fi

# Generate Promtail configuration
echo "Generating Promtail configuration at $PROMTAIL_CONFIG_FILE"
$SUDO tee "$PROMTAIL_CONFIG_FILE" > /dev/null <<EOF
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: $PROMTAIL_POSITIONS_DIR/positions.yaml

clients:
  - url: $LOKI_URL/loki/api/v1/push

scrape_configs:
- job_name: varlogs
  static_configs:
  - targets:
      - localhost
    labels:
      job: varlogs
      host: $RESOURCE_NAME
      ip: $HOST_IP
      __path__: /var/log/**/*{log,txt,out}
  - targets:
      - localhost
    labels:
      job: varlogs
      host: $RESOURCE_NAME
      ip: $HOST_IP
      __path__: /var/log/{messages,secure,cron,maillog,spooler,boot.log,syslog,auth.log,kern.log,dpkg.log,daemon.log}
EOF

# Stop and remove existing Promtail container if running
if $SUDO docker ps -a --format '{% raw %}{{.Names}}{% endraw %}' | grep -q "^promtail$"; then
    echo "Stopping and removing existing promtail container..."
    $SUDO docker stop promtail || true
    $SUDO docker rm promtail || true
fi

# Run Promtail container
echo "Starting Promtail container..."
$SUDO docker run -d \
  --name promtail \
  --restart always \
  --user 0 \
  -v $PROMTAIL_CONFIG_DIR:/etc/promtail \
  -v $PROMTAIL_POSITIONS_DIR:$PROMTAIL_POSITIONS_DIR \
  -v /var/log:/var/log \
  grafana/promtail:latest \
  -config.file=/etc/promtail/config.yaml

echo "Promtail deployed successfully."
